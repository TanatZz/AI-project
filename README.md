# Songkhla Time-Window Routing (OSM + ML)

โปรเจคตัวอย่าง Python สำหรับหา **2 เส้นทางที่ดีที่สุด** จาก A ไป B ใน **จังหวัดสงขลา** โดยคำนึงถึง
1) เวลาเปิด–ปิดของถนนแต่ละเส้น (ถ้าปิด = ห้ามใช้ ไม่รอ) และ  
2) ML (จำลอง) เพื่อปรับความเร็ว/เวลาเดินทางตามช่วงเวลา (hour of day + ประเภทถนน)

## คุณสมบัติ
- โหลดกราฟถนนจริงจาก **OpenStreetMap** (ผ่าน `osmnx`)
- รองรับ **เวลาออกเดินทาง** ตามโซนเวลาไทย (Asia/Bangkok)
- เช็ค **เวลาเปิด–ปิดถนน** จากไฟล์ CSV (กำหนดได้หลายแถวต่อถนน หลายวัน/ชั่วโมง และข้ามเที่ยงคืนได้)
- หา **k เส้นทางที่ดีที่สุด** (ค่าเริ่มต้น k=2) ด้วยน้ำหนักเป็น *เวลาเดินทางที่คาดการณ์* ณ เวลานั้น
- แสดงสรุประยะทาง/เวลา และ **บันทึกรูปภาพ** เส้นทาง (ไฟล์ `routes.png`)

> หมายเหตุ: โค้ดนี้ใช้ ML แบบ **จำลองข้อมูล** เพื่อสาธิตแนวคิด (ไม่มีดาต้าจริง) โดยเทรน `RandomForestRegressor` ให้ทำนาย `speed_factor` จาก (ชั่วโมง, ประเภทถนน) แล้วนำไปปรับ **เวลาเดินทาง** ของแต่ละ edge ในกราฟ

---

## ติดตั้ง
```bash
python -m venv .venv
source .venv/bin/activate     # บน macOS/Linux
# หรือ .venv\Scripts\activate # บน Windows (PowerShell)

pip install -r requirements.txt
```

> ต้องต่อเน็ตตอนรันครั้งแรกเพื่อให้ `osmnx` ดาวน์โหลดข้อมูล OSM ของ **Songkhla Province, Thailand**

---

## ใช้งานเร็ว ๆ
### 1) เตรียมไฟล์เวลาเปิด–ปิดถนน
แก้ไขไฟล์ `road_schedules.csv` ให้ชื่อถนน **ตรงกับ OSM** (ฟิลด์ `name`) ถ้าชื่อไม่ตรง ระบบจะถือว่า **ถนนนั้นเปิด** ตลอดเวลาโดยอัตโนมัติ

รูปแบบคอลัมน์:
- `road_name` : ชื่อถนน (ตาม OSM)
- `weekday`   : วันในสัปดาห์ (0=จันทร์ ... 6=อาทิตย์) หรือ `all`
- `open_start`: เวลาเปิดรูปแบบ `HH:MM` (เช่น `06:00`)
- `open_end`  : เวลาปิดรูปแบบ `HH:MM` (รองรับ **ข้ามเที่ยงคืน** เช่น `18:00` ถึง `02:00`)

> คุณสามารถใส่ **หลายแถว** ซ้ำชื่อถนนเดียวกันเพื่อกำหนดหลายช่วงเวลาได้

ตัวอย่างบางส่วนในไฟล์ตัวอย่าง:
```
road_name,weekday,open_start,open_end
ถนนกาญจนวนิช,all,06:00,22:00
Kanchanavanich Road,all,06:00,22:00
ถนนนิพัทธ์อุทิศ 1,all,06:00,20:00
ถนนศรีภูวนารถ,0,06:00,20:00
ถนนคนเดินสงขลา,all,18:00,02:00
```

### 2) รันหาเส้นทาง (ตัวอย่าง)
```bash
python main.py   --origin "Hat Yai Junction"   --destination "Samila Beach"   --depart "2025-10-21 17:30"
```
หรือใช้พิกัดละติจูด,ลองจิจูด (แม่นกว่าในไทย):
```bash
python main.py   --origin "7.008365,100.474925"   --destination "7.206667,100.590556"   --depart "2025-10-21 17:30"
```

ออปชันสำคัญ:
- `--k 2` จำนวนเส้นทางที่ต้องการ (ดีฟอลต์ 2)
- `--schedule_csv road_schedules.csv` ไฟล์เวลาเปิด–ปิดถนน
- `--tz Asia/Bangkok` โซนเวลา (ดีฟอลต์ Asia/Bangkok)
- `--no-plot` ถ้าไม่ต้องการสร้างรูปภาพเส้นทาง

ผลลัพธ์:
- Console: สรุปเส้นทาง (กม. และ นาที) พร้อมชื่อถนนตัวอย่าง
- ไฟล์ `routes.png`: รูปแผนที่ + เส้นทาง top-k ที่เจอ

---

## อธิบายหลักการ (ย่อ)
1) **โหลดกราฟถนน** ของ “Songkhla Province, Thailand” ด้วย `osmnx.graph_from_place(..., network_type="drive")`  
2) เติม `speed_kph` และ `travel_time` เบื้องต้นต่อ edge ด้วย `ox.add_edge_speeds` และ `ox.add_edge_travel_times`
3) **ML (จำลอง)**: สร้างข้อมูลสังเคราะห์ (ชั่วโมง 0–23 x ประเภทถนนที่มีในกราฟ) เพื่อเทรนโมเดลทำนาย `speed_factor`  
   - ช่วงพีค (7–9, 16–19) จะช้าลง โดยหนักเบาตามคลาสถนน (primary, secondary, residential ฯลฯ)  
   - ช่วงดึกจะเร็วขึ้นเล็กน้อย  
4) คำนวณ **น้ำหนักของแต่ละ edge** ณ เวลาออกเดินทาง = `base_travel_time / predicted_speed_factor`
5) **เวลาเปิด–ปิดถนน**: ถ้า edge ใดมี `name` ตรงกับถนนใน CSV แล้วช่วงเวลานั้น **ไม่เปิด** ⇒ ลบ edge นั้นออกจากกราฟ  
6) ใช้ `networkx.shortest_simple_paths` หา **k เส้นทาง** ที่เวลารวมต่ำสุด (ไม่บังคับ disjoint — อาจมีถนนซ้ำกันได้ตามสเปคงาน)
7) แสดงผล + วาดแผนที่ด้วย `osmnx.plot_graph_routes`

---

## ข้อควรระวัง
- OSM ไทยบางเส้น **ไม่มีชื่อถนน (`name`)** ⇒ จะถือว่า *ไม่มีข้อจำกัดเวลา* (เปิดตลอด)
- ชื่อถนนใน CSV ต้องตรงกับ OSM จริง ๆ (คีย์ไทย/อังกฤษ/เว้นวรรค) แนะนำให้เริ่มจากไม่กี่เส้นเพื่อสาธิต
- ถ้าช่วงเวลาปิดทำให้กราฟ **ขาดการเชื่อมต่อ** อาจหาเส้นทางไม่เจอ
- การโหลดกราฟทั้งจังหวัดอาจใช้ RAM/เวลา พอสมควรครั้งแรก (ครั้งต่อไปเร็วขึ้นเพราะแคช)

---

## License
MIT — ใช้เพื่อการศึกษา/เดโมได้เต็มที่
